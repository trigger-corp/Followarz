<html>
<head>
	<!--<script src="https://webmynd.com/catalyst/target/target-script-min.js#C85EF26E-C8CB-4C25-9D54-5C7BEE7F74A5"></script>-->
	<script type="text/javascript" src="jquery-1.7.js"></script>
	<script type="text/javascript" src="mustache.js"></script>
	<!--<script type="text/javascript" src="jquery.lazyload.js"></script>-->
	<script type="text/javascript" src="iscroll.js"></script>
	<script type="text/javascript" src="seedrandom-min.js"></script>
	<link rel="stylesheet" href="./followarz.css">
	<link rel="stylesheet" href="./iscroll.css">
	<script type="text/javascript">
		$(function() {
			forge.tools.getURL('/', function (base_url) {
				var card_template = "<li class=\"card\">\n\t<div class=\"name\">@{{ name }}</div>\n\t<img src=\"{{ url }}\" width=\"128\" height=\"128\"/>\n\t<table>\n\t\t<tr>\n\t\t\t<td>Health</td>\n\n\t\t\t<td>{{ health }}</td>\n\t\t</tr>\n\t\t<tr>\n\t\t\t<td>Strength</td>\n\t\t\t<td>{{ strength }}</td>\n\t\t</tr>\n\t\t<tr>\n\t\t\t<td>Agility</td>\n\t\t\t<td>{{ agility }}</td>\n\t\t</tr>\n\t</table>\n\t</div>\n</li>"
				var selector_template = '<div id="scroller">\n\t<ul id="followers">\n\n\t</ul>\n</div>\n';
				var team = [];

				jQuery.ajax({
					url: 'http://followarz.com/followers.php',
					dataType: 'json',
					success: function(data) {
						$('#wrapper').html(selector_template);
						data.forEach(function(follower) {
							var img_src = follower.profile_image_url_https.replace(/normal.jpg$/, 'reasonably_small.jpg');
							Math.seedrandom(follower.screen_name);
							var card = Mustache.to_html(card_template, {
								name: follower.screen_name,
								url: img_src,
								health: Math.floor(Math.random() * 100),
								strength: Math.floor(Math.random() * 100),
								agility: Math.floor(Math.random() * 100)
							});

							var $card = $(card).click(function() {
								if (team.length === 0) {
									$('#team').html('');
								}
								if (team.length == 5) {
									return;
								}
								team.push(follower.id_str);
								var $img = $('<img src="' + img_src + '">');
								var $original_card = $(this);

								$img.click(function() {
									$(this).fadeOut(function() {
										$(this).remove();
									});
									$original_card.fadeIn();
									var newTeam = [];
									team.forEach(function (member) {
										if (member != follower.id_str) {
											newTeam.push(member);
										}
									})
									team = newTeam;
									$('#save').fadeOut();
								});

								$img.load(function() {
									$(this).fadeIn();
								});

								$('#team').append($img);
								$(this).fadeOut();

								if (team.length == 5) {
									$('#save').fadeIn();
								}
							});

							$('#followers').append($card);

						});
						$('#scroller').css('width', data.length * 250);

						var myScroll = new iScroll('wrapper', {
							snap: 'li',
							momentum: false,
							hScrollbar: false
						});
					}
				});
				$('#save').one('click', function () {
					$(this).text('Saving...');
					forge.logging.log("save team");
					forge.logging.log(team);
					$.ajax({
						url: 'http://followarz.com/saveteam.php',
						data: {
							team: JSON.stringify(team)
						},
						dataType: 'json',
						success: function(data) {
							forge.logging.log("response from saveteam");
							forge.logging.log(data);
							window.location.href = base_url + 'index.html';
						}
					})
				});
			});
		});
	</script>
</head>
	<body>
		<div id="team">Tap 5 cards to choose your team members.</div>
		<div id="wrapper">Loading...</div>
		<div id="save">Save team</div>
	</body>
</html>
