<html>
<head>
	<title></title>

	<!--<script src="https://webmynd.com/catalyst/target/target-script-min.js#4580CC4F-4AC2-41ED-9D87-5BBED6E23994"></script>-->

	<script type="text/javascript" src="js/jquery-1.7.js"></script>
	<script type="text/javascript" src="js/mustache.js"></script>
	<script type="text/javascript" src="js/jQueryMustache.js"></script>
	<script type="text/javascript" src="js/iscroll.js"></script>
	<script type="text/javascript" src="js/seedrandom-min.js"></script>
	<script type="text/javascript" src="js/followarz.js"></script>
	<link rel="stylesheet" href="css/followarz.css">
	<script id="battle_template" type="x-templ-mustache">
		<div id="opposing_team">
			{{#opponent_team}}
			<img class="choice" src="{{ profile_image_url_https }}">
			{{/opponent_team}}
		</div>
		<div id="spacer">
			<div id="message">
				Choose one of your team to begin the battle.
			</div>
		</div>
		<div id="own_team">
			{{#own_team}}
			<img class="choice" src="{{ profile_image_url_https }}">
			{{/own_team}}
		</div>
	</script>
	<script id="fight_template" type="x-templ-mustache">
		<div class="hcard">
			{{#opponent}}
			<div class="half">
				<table>
					<tr>
						<td>Health</td>

						<td>{{ health }}</td>
					</tr>
					<tr>
						<td>Strength</td>
						<td>{{ strength }}</td>
					</tr>
					<tr>
						<td>Agility</td>
						<td>{{ agility }}</td>
					</tr>
				</table>
			</div>

			<div class="half">
				<div class="name">@{{ name }}</div>
				<img src="{{ img }}" width="72" height="72"/>
			</div>
			{{/opponent}}
		</div>

		<div id="card_spacer"></div>
		<div id="message">
			Fighting!
		</div>

		<div class="hcard">
			{{#own}}
			<div class="half">
				<div class="name">@{{ name }}</div>
				<img src="{{ img }}" width="72" height="72"/>
			</div>

			<div class="half">
				<table>
					<tr>
						<td>Health</td>

						<td>{{ health }}</td>
					</tr>
					<tr>
						<td>Strength</td>
						<td>{{ strength }}</td>
					</tr>
					<tr>
						<td>Agility</td>
						<td>{{ agility }}</td>
					</tr>
				</table>
			</div>
			{{/own}}
		</div>
	</script>

	<script type="text/javascript">
		var baseUrl;

		function generateStatsForCard(card) {
			Math.seedrandom(card.screen_name);
			return {
				health: Math.floor(Math.random() * 100),
				strength: Math.floor(Math.random() * 100),
				agility: Math.floor(Math.random() * 100),
				img: card.profile_image_url_https,
				name: card.screen_name
			};
		}

		function showBattlePage(ownTeam, opponentTeam, opponent_name) {
			forge.logging.log("Loading battle page.");

			var fights = [];
			var inFight = false;
			var wins = 0;

			var battleTemplate = $('#battle_template').html();
			var page = $('#battle_template').mustache({
				own_team: ownTeam,
				opponent_team: opponentTeam
			});

			$('body').html(page);

			var ownCard, opponentCard;
			var $fightTemplate = $('#fight_template');
			var $spacer = $('#spacer');

			$('#own_team > img').click(function() {
				if (inFight) {
					return;
				}
				inFight = true;

				ownCard = ownTeam[$(this).index('#own_team > img.choice')];
				if (ownCard.used) {
					return;
				}
				ownCard.used = true;

				forge.logging.log("Selected " + ownCard.screen_name + " to fight for us");
				forge.logging.log(ownCard);

				while (!opponentCard || opponentCard.used) {
					var random_index = Math.floor(Math.random() * 5);
					opponentCard = opponentTeam[random_index];
				}
				opponentCard.used = true;

				forge.logging.log("Selected " + ownCard.screen_name + " to fight against us");
				forge.logging.log(ownCard);

				var ownStats = generateStatsForCard(ownCard);
				var opponentStats = generateStatsForCard(opponentCard);

				var fightHtml = $fightTemplate.mustache({
					own: ownStats,
					opponent: opponentStats
				});

				$spacer.html(fightHtml);
				var me = this;

				setTimeout(function () {
					var $me = $(me);
					var winner;

					$me.css('opacity', 0.3);
					$($('#opposing_team > img.choice').get(random_index)).css('opacity', 0.3);

					if (Math.round(Math.random())) {
						$('#message').html('You win!<br/>Choose your next fighter!');
						var $tick = $('<img src="tick.png">').css({
							position: "absolute",
							"margin-left": -50
						});
						$me.after($tick);
						wins++;
						winner = 0;
					} else {
						$('#message').html('You lose :(<br/>Choose your next fighter!');
						var $cross = $('<img src="cross.png">').css({
							position: "absolute",
							"margin-left": -50
						});
						$me.after($cross);
						winner = 1;
					}

					fights.push({
						0: ownCard.id_string,
						1: opponentCard.id_string,
						winner: winner
					});
2
					if (fights.length === 5) {
						if (wins >= 3) {
							$('#message').html('You won this battle.<br/>Tap to tell your opponent!');
							$('#message').one('click', function () {
								forge.tabs.open("https://twitter.com/share" +
										"?url=" + encodeURIComponent("http://followarz.com/") +
										"&text=" + encodeURIComponent("@" + opponent_name + " I just beat you at Followarz! Check it out.") +
										"&related=" + encodeURIComponent(opponent_name));
							});
						} else {
							$('#message').html('You lost this battle.<br/>Tap to tell your opponent!');
							$('#message').one('click', function () {
								forge.tabs.open("https://twitter.com/share?url=" + encodeURIComponent("http://followarz.com/") +
										"&text=" + encodeURIComponent("@" + opponent_name + " I just lost to you at Followarz! Check it out.") +
										"&related=" + encodeURIComponent(opponent_name));
							});

						}

						var battle = {
							against: opponent_name,
							fights: fights
						};

						forge.logging.log("battle result");
						forge.logging.log(battle);
					}

					inFight = false;
				}, 2000);
			});
		}

		var ownTeam;
		var opposingTeam;
		var chosenOpponent;
		var opponents;

		function canStartBattle() {
			return ownTeam != undefined && opposingTeam != undefined;
		}

		function requestOwnTeam(success) {
			$.ajax({
				url: "http://followarz.com/team.php",
				dataType: "json",
				success: function (team) {
					ownTeam = team;

					forge.logging.log("Got own team");
					forge.logging.log("Team size is " + team.length);

					success && success();
				},

				error: function () {
					forge.logging.log("Failed to get own team");
					forge.logging.log(e);
				}
			});
		}

		function requestOpposingTeam(opponent, success) {
			$.ajax({
				url: "http://followarz.com/team.php?for=" + encodeURIComponent(opponent.screen_name),
				dataType: "json",
				success: function (team) {
					opposingTeam = team;

					forge.logging.log("Got opposing team");
					forge.logging.log("Team size is " + team.length);

					success && success();
				},

				error: function (e) {
					forge.logging.log("Failed to get team for opposition");
					forge.logging.log(e);
				}
			});
		}

		function requestOpponents(success) {
			var opponent_template = "<li class=\"opponent\">\n\t<img src=\"{{ url }}\"> <span class=\"name\">{{ name }}</span>\n</li>";
			$.ajax({
				url: "http://followarz.com/following.php",
				dataType: "json",

				success: function (following) {
					opponents = following;
					forge.logging.log("Got " + opponents.length + " opponents");

					success && success();
				},

				error: function (e) {
					forge.logging.log("Failed to get opponents.");
					forge.logging.log(e);
				}
			});
		}

		function showChooseOpponentPage() {
			var $opponents = $('#opponents').clone();

			opponents.forEach(function (opponent) {
				var $op = $(Mustache.to_html(opponent_template, {
					url: opponent.profile_image_url_https,
					name: opponent.screen_name
				}));

				$op.click(function () {
					if (chosenOpponent) {
						return;
					}
					chosenOpponent = opponent;

					$(this).children('.name').text('Loading opposing team...');

					requestOpposingTeam(chosenOpponent, function() {
						if (canStartBattle()) {
							showBattlePage(ownTeam, opposingTeam, chosenOpponent.screen_name);
						}
					});
				});

				$opponents.append($op);
			});

			$('#pick_message').text('Choose an opponent.');
			$('#opponents').replaceWith($opponents);
			new iScroll('wrapper');
		}

		$(function () {
			forge.tools.getURL('/', function (url) {
				baseUrl = url;
				var opponent_template = "<li class=\"opponent\">\n\t<img src=\"{{ url }}\"> <span class=\"name\">{{ name }}</span>\n</li>";

				requestOwnTeam(function () {
					if (canStartBattle()) {
						showBattlePage(ownTeam, opposingtTeam, chosenOpponent.screen_name);
					}
				});

				requestOpponents(function() {
					showChooseOpponentPage();
				});
			});
		});
	</script>

	<style type="text/css" media="all">
		body, ul, li {
			padding: 0;
			margin: 0;
			border: 0;
		}

		#wrapper {
			position: absolute;
			z-index: 1;
			top: 50px;
			bottom: 0;
			left: 0;
			width: 100%;
			overflow: auto;
		}

		#scroller {
			position: absolute;
			z-index: 1;
			/*	-webkit-touch-callout:none;*/
			-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
			width: 100%;
			padding: 0;
		}

		#scroller ul {
			list-style: none;
			padding: 0;
			margin: 0;
			width: 100%;
			text-align: left;
		}

		#scroller li {
			padding: 0 0;
			height: 50px;
			line-height: 50px;
			font-size: 14px;
		}

		img {
			vertical-align: middle;
		}

	</style>
</head>
<body>
	<p id="pick_message">Loading opponents...</p>
	<div id="wrapper">
		<div id="scroller">
			<ul id="opponents"></ul>
		</div>
	</div>
</body>
</html>